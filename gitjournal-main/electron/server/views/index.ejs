<div id="loadingSpinner" class="loading-spinner">
  <div class="spinner"></div>
  <p>Chargement des commits...</p>
</div>

<main id="mainContent" style="display: none">
  <div
    id="divHelpButton"
    class="topButton no-print"
    style="background-color: transparent; border-color: #999; color: #666"
  >
    ?
  </div>
  <header class="print-only">
    <% if (owner && repo) { %>
    <h1>Journal de travail de <%= me %> dans <%= projectName %></h1>
    <% } else { %>
    <h1>Journal de travail de <%= me %> - <%= projectName %></h1>
    <% } %>
  </header>
  <% if (owner && repo && selectedBranch != "main") { %>
  <p class="muted print-only">Branche: <strong><%= selectedBranch %></strong></p>
  <% } %> <% if (since) { %>
  <p class="muted print-only">Depuis: <strong><%= since %></strong></p>
  <% } %>

  <div id="divAddButton" class="topButton no-print">+</div>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Tâche/Commit</th>
        <th>Description</th>
        <th class="muted">Durée</th>
        <th class="muted">Statut</th>
        <th class="muted">Auteur</th>
      </tr>
    </thead>

    <tbody>
      <% groups.forEach(g => { %>
      <!-- lignes du jour -->
      <% g.commits.forEach(c => { %> <%- include('_commitRow', { c }) %> <% }) %>
      <!-- sous-total du jour -->
      <tr style="background: #fafafa; font-weight: bold">
        <td colspan="3" style="text-align: right"><%= g.label %></td>
        <td colspan="3"><%= g.total.h %>h <%= g.total.m %>m</td>
      </tr>
      <% }) %>
      <tr style="background: #ccc; font-weight: bold">
        <td colspan="3" style="text-align: right">Total du projet</td>
        <td colspan="3"><%= totals.h %>h <%= totals.m %>m</td>
      </tr>
    </tbody>
  </table>

  <div class="no-print" style="color: #ccc; font-size: 0.75rem; font-style: italic">GitJournal v<%= appVersion %></div>

  <%- include('_editEntry') %> <%- include('_helpModal') %>
</main>
<script>
  // Cacher le spinner et afficher le contenu une fois chargé
  document.addEventListener("DOMContentLoaded", function () {
    const spinner = document.getElementById("loadingSpinner");
    const content = document.getElementById("mainContent");

    if (spinner) spinner.style.display = "none";
    if (content) content.style.display = "block";
  });

  // Input form
  const openBtn = document.getElementById("divAddButton");
  const closeBtn = document.getElementById("closeBtn");
  const overlay = document.getElementById("overlay");
  const dateInput = document.querySelector('input[name="date"]');

  openBtn.onclick = () => {
    heaInputForm.innerText = "Ajout d'une entrée";
    txtName.value = "";
    txtDescription.value = "";
    numDuration.value = null;
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    datDate.value = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(
      d.getMinutes()
    )}`;
    overlay.classList.add("active");
    hidSHA.value = "-";
    exceptionId.value = "-";
    url.value = "-";

    dpdStatus.disabled = false;
    excludeBtn.style.display = "none"; // Cacher le bouton Exclure pour une nouvelle entrée
    overlay.classList.add("active");
  };
  closeBtn.onclick = () => overlay.classList.remove("active");
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.classList.remove("active");
  };

  saveBtn.onclick = () => {
    const fd = new FormData(dataForm);
    const sha = fd.get("sha");
    if (sha) {
      let patch = { sha: sha };
      const patchdescription = fd.get("description");
      const patchdate = fd.get("date");
      const patchduration = fd.get("duration");
      if (patchdescription) patch.description = patchdescription;
      if (patchdate) patch.date = patchdate;
      if (patchduration) patch.duration = patchduration;
      exceptions.push(patch);
    } else {
      exceptions.push({
        patch: true,
        name: fd.get("name"),
        description: fd.get("description"),
        date: new Date(fd.get("date")).toISOString(),
        duration: Number(fd.get("duration")),
        status: fd.get("status"),
        author: repoOwner
      });
    }
    saveData(exceptions);
    overlay.classList.remove("active");
  };

  document.querySelectorAll("tr").forEach((tr) => {
    tr.addEventListener("click", (e) => {
      // Don't interfere with link clicks (e.g., GitHub icon)
      if (e.target.tagName === "A" || e.target.closest("a")) {
        return;
      }

      const row = e.currentTarget;
      if (!row.dataset.date) return; // Ignore total rows

      e.preventDefault();
      heaInputForm.innerText = "Modification d'une entrée";
      const d = new Date(row.dataset.date);
      const pad = (n) => String(n).padStart(2, "0");
      datDate.value = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(
        d.getMinutes()
      )}`;
      // Load form fields with entry's current values
      txtName.value = row.childNodes[3].innerText;
      txtDescription.value = row.childNodes[5].innerText;
      numDuration.value = parseInt(row.dataset.duration);
      overlay.classList.add("active");
      hidSHA.value = row.dataset.sha;
      exceptionId.value = row.dataset.exceptionid;
      url.value = row.dataset.url;
      dpdStatus.value = row.dataset.status;
      author.value = row.dataset.author;

      // Afficher le bouton Exclure/Supprimer selon le type d'entrée
      if (row.dataset.sha && row.dataset.sha !== "-") {
        // C'est un commit - afficher "Exclure"
        excludeBtn.textContent = "Exclure";
        excludeBtn.style.display = "block";
      } else if (row.dataset.exceptionid && row.dataset.exceptionid !== "-") {
        // C'est une entrée manuelle - afficher "Supprimer"
        excludeBtn.textContent = "Supprimer";
        excludeBtn.style.display = "block";
      } else {
        excludeBtn.style.display = "none";
      }
    });
  });

  // Exclude/Delete button handler
  const excludeBtn = document.getElementById("excludeBtn");

  excludeBtn.onclick = async () => {
    const sha = hidSHA.value;
    const exceptionId = document.getElementById("exceptionId").value;

    // Déterminer si c'est un commit ou une entrée manuelle
    const isManualEntry = exceptionId && exceptionId !== "-";
    const isCommit = sha && sha !== "-";

    if (isManualEntry) {
      // Suppression d'une entrée manuelle
      if (!confirm("Voulez-vous vraiment supprimer cette entrée manuelle ?")) {
        return;
      }

      try {
        const response = await fetch("/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ exceptionId: exceptionId })
        });

        if (response.ok) {
          overlay.classList.remove("active");
          window.location.reload();
        } else {
          const error = await response.json();
          alert("Erreur lors de la suppression: " + (error.error || "Erreur inconnue"));
        }
      } catch (error) {
        alert("Erreur lors de la suppression: " + error.message);
      }
    } else if (isCommit) {
      // Exclusion d'un commit
      if (!confirm("Voulez-vous vraiment exclure ce commit du journal ?")) {
        return;
      }

      try {
        const response = await fetch("/exclude", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sha: sha })
        });

        if (response.ok) {
          overlay.classList.remove("active");
          window.location.reload();
        } else {
          const error = await response.json();
          alert("Erreur lors de l'exclusion: " + (error.error || "Erreur inconnue"));
        }
      } catch (error) {
        alert("Erreur lors de l'exclusion: " + error.message);
      }
    } else {
      alert("Cette entrée ne peut être ni exclue ni supprimée");
    }
  };

  // Help modal
  const helpBtn = document.getElementById("divHelpButton");
  const helpOverlay = document.getElementById("helpOverlay");

  helpBtn.onclick = () => {
    helpOverlay.classList.add("active");
  };

  helpOverlay.onclick = (e) => {
    if (e.target === helpOverlay) helpOverlay.classList.remove("active");
  };

  // Close all modals on Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      overlay.classList.remove("active");
      helpOverlay.classList.remove("active");
    }
  });
</script>
